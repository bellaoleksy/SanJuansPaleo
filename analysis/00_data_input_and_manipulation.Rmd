---
title: "00_data_input_and_manipulation"
author: "Julia Pop"
date: "2025-07-26"
output: html_document
---

```{r setup, include=FALSE}
# code to troublesheet file path issues. 
# By default, knitr uses the folder containing the .Rmd file as
# the working directory. This code allows us to set the folder
# with our .rProj in it as the root. 

# find_root looks upwards from the .Rmd until it finds a file or
# folder that matches the criteria "folder with a .Rproj file in
# it."

knitr::opts_knit$set(root.dir = rprojroot::find_root(rprojroot::is_rstudio_project))
```

# Notes to self:

1) when editing this markdown file later use head() to visualize data in the final html file! can use that to show visually how you are editing the dfs.

2) SIA_run_1_TRK_UFM needs to be rounded to an accurate number of decimal points (after calculations?); same for SIA_run_2_TRK_LFM

## Load packages

Copied directly from Bella's 00_data_entry_and_manipulation.Rmd in LochValePaleo. 
```{r message = false}

library(tidyverse)
library(ggpubr)
library(ggplot2)
library(grid) # for function unit() in ggplot2
library(gtable) # for adding subtitle in ggplot2
library(ggthemes)
library(scales) # to add percentages to plots and pretty_breaks()
library(gridExtra) # for arranging graphs side by side w ftn grid.arrange()
library(skimr) # for summary statistics
library(reshape2)
library(readxl) # to read excel files
library(writexl) # to ultimately create a .xlsx file for export
library(stringr)

#load packages necessary for GAMS
library("mgcv")
library("scam")
library("cowplot")
library("grid")                         # for unit.pmax(), unit.list()
library("schoenberg")
library("tidyr")
library("nlme")

#from Cale (delete what I don't need) 
library(tidypaleo) ### for dealing with dates and vertical plotting
library(tidyr) ## data management
library(dplyr) ## data transformation
library(ggplot2) ### plotting
library(cowplot) ## for combining plots
library(mgcv) ### for GAMs 
library(gratia) ## for improving GAMs

#troubleshooting wd issues
library(here)
```

## Pull in core metadata
```{r, echo = FALSE}
# echo = FALSE shows output but not code. 
# read in metadata 
TRK_metadata <- read_excel("data/0_TRK2_core_metadata_20250726.xlsx")  %>%
  select(lake_name:depth_bottom)

UFM_metadata <- read_excel("data/0_UFM1_core_metadata_20250726.xlsx") %>% 
  select(lake_name:depth_bottom)

LFM_metadata <- read_excel("data/0_LFM2_core_metadata_20250726.xlsx") %>% 
  select(lake_name:depth_bottom)
```

## Clean SIA Files for Peter & others

**Note: return later to** 
- round SIA_run1_TRK_UFM to the appropriate number of sig figs
- pull in run 2 and collapse any triplicates, stitch to new file named LFM_SIA!
- add TRK2_002 to TRK_SIA
- consolidate / choose perC.drft or percent.C and the corresponding C:N

```{r, echo = FALSE}
    
# Step One: pull in and clean up IRMS run info
# NOTE: these files (SIA_run1_...SIA_run2_) still contains triplicates!
SIA_run1_TRK_UFM <- read_excel("data/TRK_UFM_SIA_data_clean_20250726.xlsx") %>%
  rename(sample_ID = Identifier1) %>%
  select(sample_ID, d13C.scale, percent.C, perC.drift, d15N.scale, percent.N) %>% # pull in percent.C and perC.drift.
  mutate("C.drift:N" = perC.drift/percent.N,
         "C:N" = percent.C/percent.N) %>%
  rename(d13C = d13C.scale,
         d15N = d15N.scale)

# For now, chose to inlcude both “perC.drift” AND "percent.C" for %C since a very small drift was detected in the HOS lin.std (but either way within the error of 0.3% - where std.dev. is of multiple HOS standard replicates) For now, calculate C:N using both and see how errors propogate. In thesis use percent.C until have a reason not to.

SIA_run2_TRK_LFM <- 
  read_excel("data/TRK_LFM_SIA_data_clean_20250921.xlsx") %>%
    rename(sample_ID = Identifier1) %>%
    select(sample_ID, d13C.scale, linKpercent.C, d15N.scale, perN.drift) %>%
# standardize SIA column names across runs, 
# regardless of corrections used...
    rename(d13C = d13C.scale,
           percent.C = linKpercent.C, 
           d15N = d15N.scale,
           percent.N = perN.drift) %>%
    mutate("C:N" = percent.C/percent.N)

# Step Two: collapse triplicate values, and create a separate SIA spreadsheet for each core (in format: metadata, SIA)

# two a) join dataframes and keep all the observations in TRK_metadata (left, while throwing out any observations from SIA_run1_TRK_UFM, right, that don't have a sample_ID matching those in TRK_metadata). Right now that throws out UFM SIA, but keeps all the extra observations in the left database (e.g. TRK2_001, TRK2_002, TRK2_003...5, 7, 9)

TRK_SIA <- left_join(TRK_metadata, SIA_run1_TRK_UFM, by = "sample_ID") %>%
  select(-perC.drift, -"C.drift:N")

# two b) pull row TRK2_002 to add to the data from run 1 later
row_TRK2_002_SIA <- SIA_run2_TRK_LFM %>%
  filter(sample_ID == "TRK2_002") %>%
  left_join(TRK_metadata, by = "sample_ID") %>%
  relocate(all_of(c(
    "lake_name",
    "core_number",
    "sample_ID",
    "sample_range",
    "depth_top",
    "depth_bottom",
    "d13C",
    "percent.C",
    "d15N",
    "percent.N",
    "C:N"
  ))) # keep columns in the same order.

# two c) do regular cleaning
TRK_SIA <- TRK_SIA %>%
    drop_na() %>% # drop all TRK samples for which we did not run SIA
    group_by(lake_name, core_number, sample_ID, sample_range, depth_top, depth_bottom) %>% # add a step to run the summarize fn on groups of rows (each row could be grouped just by sample_ID, but output would then not include the other metadata; bc metadata should stay the same for duplicate samples, we can use this shortcut). 
    summarize(across(d13C:"C:N", ~mean(.x, na.rm=TRUE)), .groups = "keep") # summarize collapses rows--this fn will take the average of all the triplicates for every row (grouped by the columns above). ".x" is tidyverse's way of saying insert the line before right here when you choose what to take the mean of.

# two d) add row TRK2_002 back in
TRK_SIA <- bind_rows(TRK_SIA, row_TRK2_002_SIA)

# create a UFM stable isotope file. 
UFM_SIA <- left_join(UFM_metadata, SIA_run1_TRK_UFM, by = "sample_ID") %>%
    select(-perC.drift, -"C.drift:N")

UFM_SIA <- UFM_SIA %>%
    drop_na() %>%
    group_by(lake_name, core_number, sample_ID, sample_range, depth_top, depth_bottom) %>%
    summarize(across(d13C:"C:N", ~mean(.x, na.rm=TRUE)), .groups = "keep")
  
# create an LFM stable isotope file.
LFM_SIA <- left_join(LFM_metadata, SIA_run2_TRK_LFM, by = "sample_ID") %>%
  drop_na() %>%
  group_by(lake_name, core_number, sample_ID, sample_range, depth_top, depth_bottom) %>%
  summarize(across(d13C:"C:N", ~mean(.x, na.rm=TRUE)), .groups = "keep")

# export data for Peter
# write_xlsx(TRK_SIA, path = "output/TRK_SIA_for_leavitt.xlsx")
# write_xlsx(UFM_SIA, path = "output/UFM_SIA_for_leavitt.xlsx")

# clean up Environment: 
rm(row_TRK2_002_SIA)
```

# Pigments
### Pull in pigment data
```{r}

# all raw pigment data is in the units nmol pigment / g total dry mass (code below adds the suffix "_nmol_gDM"). 

UFM_pigments_raw <- read_excel("data/UFM_final_HPLC_20250910.xlsx") %>% 
  select(depth_top, chlide_a:diadino, myxo:car_z) %>%
  rename(b_car = "b-car") %>% 
  rename_with(~paste0(.x, "_nmol_gDM"), .cols = c(chlide_a:car_z))

LFM_pigments_raw <- read_excel("data/LFM_final_HPLC_20250910.xlsx") %>% 
  select(depth_top, chlide_a:diadino, myxo:car_z) %>%
  rename(b_car = "b-car") %>% 
  rename_with(~paste0(.x, "_nmol_gDM"), .cols = c(chlide_a:car_z))

TRK_pigments_raw <- read_excel("data/TRK_final_HPLC_20250910.xlsx") %>% 
  select(depth_top, chlide_a:diadino, myxo:car_z) %>%
  rename(b_car = "b-car") %>% 
  rename_with(~paste0(.x, "_nmol_gDM"), .cols = c(chlide_a:car_z))

# glimpse(UFM_pigments_raw) # 31 pigments total!

```

### Join pigment and SIA dfs
```{r}
# join and add a depth_plot column
UFM_wide <- left_join(UFM_SIA, UFM_pigments_raw, by = "depth_top") %>%
  mutate(depth_plot = depth_top + 0.25) %>%
  relocate(depth_plot, .after = depth_bottom)

TRK_wide <- left_join(TRK_SIA, TRK_pigments_raw, by = "depth_top") %>%
  mutate(depth_plot = depth_top + 0.25) %>%
  relocate(depth_plot, .after = depth_bottom)

LFM_wide <- left_join(LFM_SIA, LFM_pigments_raw, by = "depth_top") %>%
  mutate(depth_plot = depth_top + 0.25) %>%
  relocate(depth_plot, .after = depth_bottom)

# glimpse(UFM_wide)
```

### Recalculate pigment data to compare total DM to TC
```{r}
# to get nmoles / g TC, multiply by 100/percent.C, and add label _nmol_gTC

UFM_wide <- UFM_wide %>%
  # for all the columns that end in _nmol_gDM
  mutate(across(ends_with("_nmol_gDM"), 
  # multiply by (100/percent.C)
  ~ .x * (100/percent.C), 
  # name the new column pigment_scaled
  .names = "{.col}_scaled")) %>%
  
  # rename all scaled columns (and not the original columns) with new unit
  rename_with(~ sub("_nmol_gDM_scaled$", "_nmol_gTC", .x), ends_with("_scaled"))

TRK_wide <- TRK_wide %>%
  mutate(across(ends_with("_nmol_gDM"), 
  ~ .x * (100/percent.C), 
  .names = "{.col}_scaled")) %>%
  rename_with(~ sub("_nmol_gDM_scaled$", "_nmol_gTC", .x), ends_with("_scaled"))

LFM_wide <- LFM_wide %>%
  mutate(across(ends_with("_nmol_gDM"), 
  ~ .x * (100/percent.C), 
  .names = "{.col}_scaled")) %>%
  rename_with(~ sub("_nmol_gDM_scaled$", "_nmol_gTC", .x), ends_with("_scaled"))

```

### Visualize pigment unit differences
```{r}

ggplot(UFM_wide, aes(x = depth_top, y = chl_a_nmol_gDM)) +
  geom_point(size = 2, color = "darkgreen", na.rm = TRUE) +
  geom_line(color = "darkgreen", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Chl-a (nmol/gDM)") +
  theme_minimal()

ggplot(UFM_wide, aes(x = depth_top, y = chl_a_nmol_gTC)) +
  geom_point(size = 2, color = "darkgreen", na.rm = TRUE) +
  geom_line(color = "darkgreen", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Chl-a (nmol/gTC)") +
  theme_minimal()

ggplot(UFM_wide, aes(x = depth_top, y = echine_nmol_gDM)) +
  geom_point(size = 2, color = "green3", na.rm = TRUE) +
  geom_line(color = "green3", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Echinenone (nmol/gDM)") +
  theme_minimal()

ggplot(UFM_wide, aes(x = depth_top, y = echine_nmol_gTC)) +
  geom_point(size = 2, color = "green3", na.rm = TRUE) +
  geom_line(color = "green3", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Echinenone (nmol/gTC)") +
  theme_minimal()

ggplot(UFM_wide, aes(x = depth_top, y = diato_nmol_gDM)) +
  geom_point(size = 2, color = "yellowgreen", na.rm = TRUE) +
  geom_line(color = "yellowgreen", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Diatoxanthin (nmol/gDM)") +
  theme_minimal()

ggplot(UFM_wide, aes(x = depth_top, y = diato_nmol_gTC)) +
  geom_point(size = 2, color = "yellowgreen", na.rm = TRUE) +
  geom_line(color = "yellowgreen", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Diatoxanthin (nmol/gTC)") +
  theme_minimal()

ggplot(TRK_wide, aes(x = depth_top, y = chl_a_nmol_gDM)) +
  geom_point(size = 2, color = "steelblue", na.rm = TRUE) +
  geom_line(color = "steelblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Chl-a (nmol/gDM)") +
  theme_minimal()

ggplot(TRK_wide, aes(x = depth_top, y = chl_a_nmol_gTC)) +
  geom_point(size = 2, color = "steelblue", na.rm = TRUE) +
  geom_line(color = "steelblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Chl-a (nmol/gTC)") +
  theme_minimal()


ggplot(TRK_wide, aes(x = depth_top, y = echine_nmol_gDM)) +
  geom_point(size = 2, color = "blue4", na.rm = TRUE) +
  geom_line(color = "blue4", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Echinenone (nmol/gDM)") +
  theme_minimal()

ggplot(TRK_wide, aes(x = depth_top, y = echine_nmol_gTC)) +
  geom_point(size = 2, color = "blue4", na.rm = TRUE) +
  geom_line(color = "blue4", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Echinenone (nmol/gTC)") +
  theme_minimal()

ggplot(TRK_wide, aes(x = depth_top, y = diato_nmol_gDM)) +
  geom_point(size = 2, color = "royalblue", na.rm = TRUE) +
  geom_line(color = "royalblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Diatoxanthin (nmol/gDM)") +
  theme_minimal()

ggplot(TRK_wide, aes(x = depth_top, y = diato_nmol_gTC)) +
  geom_point(size = 2, color = "royalblue", na.rm = TRUE) +
  geom_line(color = "royalblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Diatoxanthin (nmol/gTC)") +
  theme_minimal()

```

**Pigments missing from every core:** chlide_a, chl_c1, chl_c2, peridinin, sed_a, sed_b, sed_c, oscil, aphan, viola, diadino, myxo, zea, okenone, isoren, a_car, car_x, car_y, car_z

**pigments in every core:** *fuco (drops off in TRK)*, allo, diato, lutein, *cantha (none in TRK)*, chl_b, chl_a, chl_ap, echine, phaeo_b, pheo_a, b_car.

**Pigments focused on in bella's paper:** 
allo, diato, lutein, *cantha*, *myxo*, *zea*, echine, phaeo_b, pheo_a, b_car

**Missing from my data, in Bellas:** myxo, zea, cantha (none in TRK), diadino 

**Consider later:** 
- why is there no diadino? what does that say about diatoms given diato...?
- these cores were old when analyzed (and experienced more freeze-thaw cycles than is ideal): what do the preservation indices tell us about the reliability of the values we obtained, and or the many zeroes. 
- how can you assess the extent of post-depositional degradation of a given pigment? 
- interpret AD ratio? perc_chlb, etc.
- compare pigments in cyanos with those in vascular plants? no. Per Peter most chl degrades by the time it reaches the water column. 

**Remove from short dfs:** chlide_a, chl_c1, chl_c2, peridinin, sed_a, sed_b, sed_c, oscil, aphan, viola, diadino, myxo, zea, okenone, isoren, a_car, car_x, car_y, car_z

### Clean up dfs, add pigment metrics
```{r}
TRK_short <- TRK_wide %>% # make a new subset df with variables of interest
  select(-ends_with("_gDM"), # remove pigments with g / dry mass unit
         -chlide_a_nmol_gTC, # remove pigments with 0 values 
         -chl_c1_nmol_gTC,
         -chl_c2_nmol_gTC, 
         -perid_nmol_gTC, 
         -sed_a_nmol_gTC, 
         -sed_b_nmol_gTC, 
         -sed_c_nmol_gTC, 
         -oscil_nmol_gTC, 
         -aphan_nmol_gTC, 
         -viola_nmol_gTC, 
         -diadino_nmol_gTC, 
         -myxo_nmol_gTC, 
         -zea_nmol_gTC,
         -okenone_nmol_gTC, 
         -isoren_nmol_gTC, 
         -a_car_nmol_gTC,
         -car_x_nmol_gTC,
         -car_y_nmol_gTC, 
         -car_z_nmol_gTC) %>%
  mutate(chla_pheoa = chl_a_nmol_gTC + pheo_a_nmol_gTC, # add new columns
         chlb_pheob = chl_b_nmol_gTC + phaeo_b_nmol_gTC,
         all_chl = chl_a_nmol_gTC + pheo_a_nmol_gTC + chl_ap_nmol_gTC, # no chlide, chl_c1 or chl_c2 in any core
         # all_diat = diato_nmol_gTC + diadino_nmol_gTC, NO DIADINO
         PI = chl_a_nmol_gTC/pheo_a_nmol_gTC, # preservation index
         # UVR_index = sed_c_nmol_gTC / (allo_nmol_gTC + diato_nmol_gTC+lutein_nmol_gTC)
         # no sed C in any core
         AD_ratio = allo_nmol_gTC / diato_nmol_gTC, 
         master_chl = (chl_a_nmol_gTC + chl_b_nmol_gTC) / (chl_ap_nmol_gTC + pheo_a_nmol_gTC + phaeo_b_nmol_gTC),
         perc_chlb = (phaeo_b_nmol_gTC / pheo_a_nmol_gTC), 
         perc_diatox = (diato_nmol_gTC/chla_pheoa))
    
UFM_short <- UFM_wide %>% # make a new subset df with variables of interest
  select(-ends_with("_gDM"), # remove pigments with g / dry mass unit
         -chlide_a_nmol_gTC, # remove pigments with 0 values 
         -chl_c1_nmol_gTC,
         -chl_c2_nmol_gTC, 
         -perid_nmol_gTC, 
         -sed_a_nmol_gTC, 
         -sed_b_nmol_gTC, 
         -sed_c_nmol_gTC, 
         -oscil_nmol_gTC, 
         -aphan_nmol_gTC, 
         -viola_nmol_gTC, 
         -diadino_nmol_gTC, 
         -myxo_nmol_gTC, 
         -zea_nmol_gTC,
         -okenone_nmol_gTC, 
         -isoren_nmol_gTC, 
         -a_car_nmol_gTC,
         -car_x_nmol_gTC,
         -car_y_nmol_gTC, 
         -car_z_nmol_gTC) %>%
  mutate(chla_pheoa = chl_a_nmol_gTC + pheo_a_nmol_gTC, # add new columns
         chlb_pheob = chl_b_nmol_gTC + phaeo_b_nmol_gTC,
         all_chl = chl_a_nmol_gTC + pheo_a_nmol_gTC + chl_ap_nmol_gTC, # no chlide, chl_c1 or chl_c2 in any core
         # all_diat = diato_nmol_gTC + diadino_nmol_gTC, NO DIADINO
         PI = chl_a_nmol_gTC/pheo_a_nmol_gTC, # preservation index
         # UVR_index = sed_c_nmol_gTC / (allo_nmol_gTC + diato_nmol_gTC+lutein_nmol_gTC)
         # no sed C in any core
         AD_ratio = allo_nmol_gTC / diato_nmol_gTC, 
         master_chl = (chl_a_nmol_gTC + chl_b_nmol_gTC) / (chl_ap_nmol_gTC + pheo_a_nmol_gTC + phaeo_b_nmol_gTC),
         perc_chlb = (phaeo_b_nmol_gTC / pheo_a_nmol_gTC), 
         perc_diatox = (diato_nmol_gTC/chla_pheoa))


# LFM_short
LFM_short <- LFM_wide %>% # make a new subset df with variables of interest
  select(-ends_with("_gDM"), # remove pigments with g / dry mass unit
         -chlide_a_nmol_gTC, # remove pigments with 0 values 
         -chl_c1_nmol_gTC,
         -chl_c2_nmol_gTC, 
         -perid_nmol_gTC, 
         -sed_a_nmol_gTC, 
         -sed_b_nmol_gTC, 
         -sed_c_nmol_gTC, 
         -oscil_nmol_gTC, 
         -aphan_nmol_gTC, 
         -viola_nmol_gTC, 
         -diadino_nmol_gTC, 
         -myxo_nmol_gTC, 
         -zea_nmol_gTC,
         -okenone_nmol_gTC, 
         -isoren_nmol_gTC, 
         -a_car_nmol_gTC,
         -car_x_nmol_gTC,
         -car_y_nmol_gTC, 
         -car_z_nmol_gTC) %>%
  mutate(chla_pheoa = chl_a_nmol_gTC + pheo_a_nmol_gTC, # add new columns
         chlb_pheob = chl_b_nmol_gTC + phaeo_b_nmol_gTC,
         all_chl = chl_a_nmol_gTC + pheo_a_nmol_gTC + chl_ap_nmol_gTC, # no chlide, chl_c1 or chl_c2 in any core
         # all_diat = diato_nmol_gTC + diadino_nmol_gTC, NO DIADINO
         PI = chl_a_nmol_gTC/pheo_a_nmol_gTC, # preservation index
         # UVR_index = sed_c_nmol_gTC / (allo_nmol_gTC + diato_nmol_gTC+lutein_nmol_gTC)
         # no sed C in any core
         AD_ratio = allo_nmol_gTC / diato_nmol_gTC, 
         master_chl = (chl_a_nmol_gTC + chl_b_nmol_gTC) / (chl_ap_nmol_gTC + pheo_a_nmol_gTC + phaeo_b_nmol_gTC),
         perc_chlb = (phaeo_b_nmol_gTC / pheo_a_nmol_gTC), 
         perc_diatox = (diato_nmol_gTC/chla_pheoa))

```

## Add pigment metrics to wide dfs
```{r}
# Adding summary pigment metrics to wide df. NOTE, only calculating for gTC, & all units are in gTC

TRK_wide <- TRK_wide %>%
   mutate(chla_pheoa = chl_a_nmol_gTC + pheo_a_nmol_gTC, 
         chlb_pheob = chl_b_nmol_gTC + phaeo_b_nmol_gTC,
         all_chl = chl_a_nmol_gTC + pheo_a_nmol_gTC + chl_ap_nmol_gTC, 
         PI = chl_a_nmol_gTC/pheo_a_nmol_gTC,
         AD_ratio = allo_nmol_gTC / diato_nmol_gTC, 
         master_chl = (chl_a_nmol_gTC + chl_b_nmol_gTC) / (chl_ap_nmol_gTC + pheo_a_nmol_gTC + phaeo_b_nmol_gTC),
         perc_chlb = (phaeo_b_nmol_gTC / pheo_a_nmol_gTC), 
         perc_diatox = (diato_nmol_gTC/chla_pheoa)) %>%
  relocate(chla_pheoa:last_col(), .after = car_z_nmol_gTC)
  
UFM_wide <- UFM_wide %>%
    mutate(chla_pheoa = chl_a_nmol_gTC + pheo_a_nmol_gTC, 
         chlb_pheob = chl_b_nmol_gTC + phaeo_b_nmol_gTC,
         all_chl = chl_a_nmol_gTC + pheo_a_nmol_gTC + chl_ap_nmol_gTC, 
         PI = chl_a_nmol_gTC/pheo_a_nmol_gTC,
         AD_ratio = allo_nmol_gTC / diato_nmol_gTC, 
         master_chl = (chl_a_nmol_gTC + chl_b_nmol_gTC) / (chl_ap_nmol_gTC + pheo_a_nmol_gTC + phaeo_b_nmol_gTC),
         perc_chlb = (phaeo_b_nmol_gTC / pheo_a_nmol_gTC), 
         perc_diatox = (diato_nmol_gTC/chla_pheoa)) %>%
  relocate(chla_pheoa:last_col(), .after = car_z_nmol_gTC)

LFM_wide <- LFM_wide %>%
    mutate(chla_pheoa = chl_a_nmol_gTC + pheo_a_nmol_gTC, 
         chlb_pheob = chl_b_nmol_gTC + phaeo_b_nmol_gTC,
         all_chl = chl_a_nmol_gTC + pheo_a_nmol_gTC + chl_ap_nmol_gTC, 
         PI = chl_a_nmol_gTC/pheo_a_nmol_gTC,
         AD_ratio = allo_nmol_gTC / diato_nmol_gTC, 
         master_chl = (chl_a_nmol_gTC + chl_b_nmol_gTC) / (chl_ap_nmol_gTC + pheo_a_nmol_gTC + phaeo_b_nmol_gTC),
         perc_chlb = (phaeo_b_nmol_gTC / pheo_a_nmol_gTC), 
         perc_diatox = (diato_nmol_gTC/chla_pheoa)) %>%
  relocate(chla_pheoa:last_col(), .after = car_z_nmol_gTC)

```


### Evaluate PI
```{r}
# visualize chl_a and PI, (doublecheck?) if PI spikes near surface, increase in Chl_a near depth 0 may be suspect / preservation effects. 

ggplot(UFM_short, aes(x = depth_top, y = chl_a_nmol_gTC)) +
  geom_point(size = 2, color = "darkgreen", na.rm = TRUE) +
  geom_line(color = "darkgreen", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Chl-a (nmol/gTC)") +
  theme_minimal()

ggplot(UFM_short, aes(x = depth_top, y = PI)) +
  geom_point(size = 2, color = "darkgreen", na.rm = TRUE) +
  geom_line(color = "darkgreen", na.rm = TRUE) +
  labs(
    title = "Upper Fourmile",
    x = "Depth top (cm)",
    y = "Preservation Index") +
  theme_minimal()

ggplot(TRK_short, aes(x = depth_top, y = chl_a_nmol_gTC)) +
  geom_point(size = 2, color = "steelblue", na.rm = TRUE) +
  geom_line(color = "steelblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Chl-a (nmol/gTC)") +
  theme_minimal()

ggplot(TRK_short, aes(x = depth_top, y = chla_pheoa)) +
  geom_point(size = 2, color = "steelblue", na.rm = TRUE) +
  geom_line(color = "steelblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Total Chl-a's (nmol/gTC)") +
  theme_minimal()

ggplot(TRK_short, aes(x = depth_top, y = pheo_a_nmol_gTC)) +
  geom_point(size = 2, color = "steelblue", na.rm = TRUE) +
  geom_line(color = "steelblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Pheo-a (nmol/gTC)") +
  theme_minimal()

ggplot(TRK_short, aes(x = depth_top, y = PI)) +
  geom_point(size = 2, color = "steelblue", na.rm = TRUE) +
  geom_line(color = "steelblue", na.rm = TRUE) +
  labs(
    title = "Turkey Creek",
    x = "Depth top (cm)",
    y = "Preservation Index") +
  theme_minimal()

```

# Date Interpolation
```{r}
##### Interpolate 210Pb dates

### read in data from Flett
all_dates <- read_excel("data/Flett_dates_simplified_20250917.xlsx")

UFM_dates <- all_dates %>%
    filter(str_starts(sample_ID, "UFM")) %>% # select only UFM rows
    # join, removing depth top and bottom before pulling in UFM_metadata
    left_join(UFM_metadata %>% select(-depth_top, -depth_bottom), 
              by = "sample_ID") %>% 
    relocate(all_of(c(names(UFM_metadata)))) %>%
    # keep columns in the same order as in the metadata doc.
    mutate(year_CE = 2025 - extrap_bottom_age_lin)
       # NOTE !!!
       # AGES CORRESPOND TO EXTRAP BOTTOM!
       # UFM ages derived from linear model!

  # repeat for TRK (make year_CE column)
  TRK_dates <- all_dates %>%
        filter(str_starts(sample_ID, "TRK")) %>%
        left_join(TRK_metadata %>% select(-depth_top, -depth_bottom),
                  by = "sample_ID") %>%
        relocate(all_of(c(names(TRK_metadata)))) %>%
        mutate(year_CE = 2025 - extrap_bottom_age_CRS) %>% 
        filter(!sample_ID %in% c("TRK2_058", "TRK2_082"))  # remove specific samples
    
         # NOTE !!!
         # AGES CORRESPOND TO EXTRAP BOTTOM!
         # TRK ages come from lin-derived CRS!!!
  
    # the issue here is that TRK_metadata has different depth_top and _bottoms from TRK_dates
    # because Flett reassigned dates for TRK2_058 and TRK2_082
    # those are the ones we dropped, but in the adm we want the metadata depths. 
    
    # discuss with Bella how to handle splitting of the core. for now proceed with bottom portion of reconstructed core
    # (portion with no reassigned depths)

  # repeat for LFM
  LFM_dates <- all_dates %>%
        filter(str_starts(sample_ID, "LFM")) %>%
        left_join(LFM_metadata %>% select(-depth_top, -depth_bottom),
                  by = "sample_ID") %>%
        relocate(all_of(c(names(LFM_metadata)))) %>%
        mutate(year_CE = 2025 - extrap_bottom_age_CRS)
         # NOTE !!!
         # AGES CORRESPOND TO EXTRAP BOTTOM!
         # LFM ages derived from CRS (simple)

### turn it into an age-depth model (adm) that tidypaleo recognizes

UFM_dates_clean <- UFM_dates %>% # filter to remove nas
  filter(!is.na(extrap_bottom) & !is.na(year_CE)) 

# calculate adm
UFM_adm <- age_depth_model(UFM_dates_clean,
                           depth = extrap_bottom,
                           age = year_CE)

  # Repeat for LFM
  LFM_dates_clean <- LFM_dates %>% # filter to remove nas
    filter(!is.na(extrap_bottom) & !is.na(year_CE)) 
  LFM_adm <- age_depth_model(LFM_dates_clean,
                             depth = extrap_bottom,
                             age = year_CE)
  
  # Repeat for TRK
  TRK_dates_clean <- TRK_dates %>% # filter to remove nas
    filter(!is.na(extrap_bottom) & !is.na(year_CE)) 
  TRK_adm <- age_depth_model(TRK_dates_clean,
                             depth = extrap_bottom,
                             age = year_CE)

### plot the age-depth model
# very basic, but shows the trend
plot(UFM_adm)
plot(LFM_adm)
plot(TRK_adm)





### Interpolate dates
# Cale: in order to model or do any other analyses by time we 
# need to interpolate the missing dates between the estimate points
# we can do this with a predict function

# JP: Pb-210 samples are on odd samples 1-20 and even after that. 
# For pigments we want dates from even 1 - end. i.e. 0.75, 1.75, 2.75 etc.

# dates_clean length (lowest extrap_bottom)
  # UFM: 4.75 cm
  # LFM: 17.75 cm
  # TRK: 10.75 cm

# NOTE: SWITCHING HERE FROM EXTRAP BOTTOM TO REGULAR depth_bottom

# interpolate adm to all TRK segments in the dated range with SIA or pigment measurements
TRK_interp <- predict(TRK_adm, depth = seq(0.75, 10.75, 1.0)) %>%
  mutate(depth_plot = depth, # calling this depth_plot so it merges more easily in the next step
         # really it's just the age at that depth
         year_CE = age) %>%
  select(depth_plot, year_CE)

TRK_wide <- left_join(TRK_wide, TRK_interp, by = "depth_plot")
TRK_short <- left_join(TRK_short, TRK_interp, by = "depth_plot") 
  
    # repeat for UFM, lowest depth 4.75 cm
  UFM_interp <- predict(UFM_adm, depth = seq(0.75, 4.75, 1.0)) %>%
    mutate(depth_plot = depth, # calling this depth_plot so it merges more easily in the next step
           # really it's just the age at that depth
           year_CE = age) %>%
    select(depth_plot, year_CE)
  
  UFM_wide <- left_join(UFM_wide, UFM_interp, by = "depth_plot")
  UFM_short <- left_join(UFM_short, UFM_interp, by = "depth_plot") 

    # repeat for LFM, lowest depth 17.75
  LFM_interp <- predict(LFM_adm, depth = seq(0.75, 17.75, 1.0)) %>%
    mutate(depth_plot = depth, # calling this depth_plot so it merges more easily in the next step
           # really it's just the age at that depth
           year_CE = age) %>%
    select(depth_plot, year_CE)
  
  LFM_wide <- left_join(LFM_wide, LFM_interp, by = "depth_plot")
  LFM_short <- left_join(LFM_short, LFM_interp, by = "depth_plot") 

```
# Wide to Long
```{r}

# At a glance look at all parameters in an individual core

# Start with TRK

TRK_short %>%
  pivot_longer(d13C:perc_diatox) %>%
  ggplot(aes(x=depth_top, y=value, color=name))+
  geom_point()+
  geom_line()+
  geom_smooth(method="gam")+ # "really easy to plot a gam"
  facet_wrap(.~name, scales="free_y")+
  theme(legend.position="none")

UFM_short %>%
  pivot_longer(d13C:perc_diatox) %>%
  ggplot(aes(x=depth_top, y=value, color=name))+
  geom_point()+
  geom_line()+
  facet_wrap(.~name, scales="free_y")+
  theme(legend.position="none")

LFM_short %>%
  pivot_longer(d13C:perc_diatox) %>%
  ggplot(aes(x=depth_top, y=value, color=name))+
  geom_point()+
  geom_line()+
  facet_wrap(.~name, scales="free_y")+
  theme(legend.position="none")

```

# Combine spreadsheets
```{r}
# make wide long then export? don't need to combine sheets or make them long... 
```

# Export
```{r}
write.csv(LFM_wide, file="output/LFM_wide.csv")
write.csv(UFM_wide, file="output/UFM_wide.csv")
write.csv(TRK_wide, file="output/TRK_wide.csv")
write.csv(LFM_short, file="output/LFM_short.csv")
write.csv(UFM_short, file="output/UFM_short.csv")
write.csv(TRK_short, file="output/TRK_short.csv")
```